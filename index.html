<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Desbloquear Conteúdo</title>
    
    <!-- Google Fonts: Inter (Fonte limpa padrão de apps modernos) -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                    colors: {
                        of: {
                            blue: '#00AFF0',
                            darkBlue: '#009ce0',
                            bg: '#f8fafc',
                            text: '#242529',
                            gray: '#8a96a3',
                            border: '#e0e6ea'
                        }
                    },
                    boxShadow: {
                        'up': '0 -4px 15px rgba(0, 0, 0, 0.05)',
                    }
                }
            }
        }
    </script>
    <style>
        /* Oculta scrollbar mas mantém funcionalidade */
        ::-webkit-scrollbar { width: 0px; background: transparent; }
        
        /* Animação para o modal do PIX (Bottom Sheet) */
        @keyframes slideUp {
            from { transform: translateY(100%); }
            to { transform: translateY(0); }
        }
        .slide-up {
            animation: slideUp 0.3s cubic-bezier(0.16, 1, 0.3, 1) forwards;
        }
        
        /* Animação para a tela de sucesso do PIX */
        @keyframes scaleUp {
            0% { transform: scale(0.5); opacity: 0; }
            100% { transform: scale(1); opacity: 1; }
        }
        .scale-up {
            animation: scaleUp 0.4s cubic-bezier(0.16, 1, 0.3, 1) forwards;
        }
    </style>
    
    <!-- Meta Pixel Code -->
    <script>
        !function(f,b,e,v,n,t,s){if(f.fbq)return;n=f.fbq=function(){n.callMethod?n.callMethod.apply(n,arguments):n.queue.push(arguments)};if(!f._fbq)f._fbq=n;n.push=n;n.loaded=!0;n.version='2.0';n.queue=[];t=b.createElement(e);t.async=!0;t.src='https://connect.facebook.net/en_US/fbevents.js';s=b.getElementsByTagName(e)[0];s.parentNode.insertBefore(t,s)}(window,document,'script');
    </script>
    <noscript><img height="1" width="1" style="display:none" src="https://www.facebook.com/tr?id=1817379038816925&ev=PageView&noscript=1"/></noscript>
    <!-- End Meta Pixel Code -->
</head>
<body class="bg-gray-100 text-of-text font-sans antialiased selection:bg-of-blue selection:text-white flex justify-center">

    <!-- App Container (Mobile Simulator no Desktop) -->
    <div class="w-full max-w-md bg-white min-h-screen relative shadow-2xl flex flex-col overflow-hidden">
        
        <!-- Header Fixo -->
        <header class="sticky top-0 z-30 bg-white/90 backdrop-blur-md border-b border-of-border flex items-center px-4 py-3">
            <button class="text-of-text hover:text-of-blue transition-colors p-2 -ml-2">
                <i class="fa-solid fa-arrow-left text-lg"></i>
            </button>
            <h1 class="font-bold text-lg ml-2 tracking-tight uppercase">Assinar</h1>
        </header>

        <!-- Área de Rolagem Principal -->
        <main class="flex-1 overflow-y-auto pb-32">
            
            <!-- Cover & Avatar Simulados -->
            <div class="relative">
                <!-- Cover Image (Gradient placeholder) -->
                <div class="h-32 bg-gradient-to-r from-blue-100 to-of-blue/30 w-full object-cover"></div>
                
                <!-- Avatar -->
                <div class="absolute -bottom-10 left-4">
                    <div class="w-20 h-20 rounded-full border-4 border-white bg-gray-200 overflow-hidden relative shadow-sm">
                        <!-- Imagem de avatar -->
                        <img src="https://i.postimg.cc/JzPgQWKV/5159120317052554115.jpg" alt="Carolzinha" class="w-full h-full object-cover">
                    </div>
                </div>
            </div>

            <!-- Profile Info -->
            <div class="mt-12 px-4 pb-4 border-b border-of-border">
                <div class="flex items-center gap-1">
                    <h2 class="text-xl font-bold text-of-text tracking-tight">Carolzinha</h2>
                    <i class="fa-solid fa-circle-check text-of-blue text-sm"></i>
                </div>
                <p class="text-of-gray text-sm">@carolzinha</p>
                
                <p class="mt-3 text-sm text-of-text leading-relaxed">
                    Desbloqueie agora para ter acesso instantâneo a todo o conteúdo restrito, chat privado e atualizações diárias.
                </p>
            </div>

            <!-- Seleção de Pacotes -->
            <div class="px-4 py-5">
                <h3 class="text-sm font-semibold text-of-gray uppercase tracking-wider mb-3">Escolha seu pacote</h3>
                
                <div class="flex flex-col gap-3">
                    
                    <!-- Basic Card -->
                    <label class="relative flex items-center p-4 border rounded-xl cursor-pointer transition-all duration-200" id="card-basic">
                        <input type="radio" name="package" value="basic" class="peer hidden" onchange="updateSelection()">
                        <div class="flex-1">
                            <h4 class="font-bold text-base">Pacote Básico</h4>
                            <p class="text-xs text-of-gray mt-0.5">Acesso inicial ao conteúdo restrito.</p>
                        </div>
                        <div class="text-right">
                            <span class="font-bold text-lg">$14</span>
                        </div>
                        <!-- Círculo de seleção -->
                        <div class="absolute right-4 top-1/2 -translate-y-1/2 w-5 h-5 rounded-full border-2 border-of-border flex items-center justify-center peer-checked:border-of-blue peer-checked:bg-of-blue transition-all" id="check-basic">
                            <i class="fa-solid fa-check text-white text-[10px] opacity-0" id="icon-basic"></i>
                        </div>
                    </label>

                    <!-- Premium Card -->
                    <label class="relative flex items-center p-4 border rounded-xl cursor-pointer transition-all duration-200 border-of-blue bg-blue-50/50" id="card-premium">
                        <input type="radio" name="package" value="premium" class="peer hidden" checked onchange="updateSelection()">
                        <!-- Badge Popular -->
                        <div class="absolute -top-2.5 left-4 bg-of-blue text-white text-[10px] font-bold px-2 py-0.5 rounded-full uppercase">
                            Mais Popular
                        </div>
                        <div class="flex-1">
                            <h4 class="font-bold text-base">Pacote Premium</h4>
                            <p class="text-xs text-of-gray mt-0.5">Acesso VIP completo + Bônus e Chat.</p>
                        </div>
                        <div class="text-right pr-6">
                            <span class="font-bold text-lg text-of-blue">$29</span>
                        </div>
                        <!-- Círculo de seleção -->
                        <div class="absolute right-4 top-1/2 -translate-y-1/2 w-5 h-5 rounded-full border-2 border-of-blue bg-of-blue flex items-center justify-center transition-all" id="check-premium">
                            <i class="fa-solid fa-check text-white text-[10px] opacity-100" id="icon-premium"></i>
                        </div>
                    </label>
                </div>
            </div>

            <!-- Seleção de Pagamento -->
            <div class="px-4 pb-6">
                <h3 class="text-sm font-semibold text-of-gray uppercase tracking-wider mb-3">Forma de Pagamento</h3>
                
                <div class="grid grid-cols-2 gap-3">
                    <!-- Stripe Button -->
                    <button id="btn-card" onclick="setPayment('card')" class="flex flex-col items-center justify-center p-3 border-2 border-of-blue bg-blue-50/30 rounded-xl transition-all">
                        <i class="fa-regular fa-credit-card text-2xl text-of-text mb-1"></i>
                        <span class="text-sm font-semibold">Cartão (USD)</span>
                    </button>
                    
                    <!-- PIX Button -->
                    <button id="btn-pix" onclick="setPayment('pix')" class="flex flex-col items-center justify-center p-3 border-2 border-of-border bg-white rounded-xl transition-all text-of-gray hover:border-gray-300">
                        <i class="fa-brands fa-pix text-2xl mb-1"></i>
                        <span class="text-sm font-semibold">PIX (BRL)</span>
                    </button>
                </div>

                <!-- Info Cotação PIX -->
                <div id="pix-info" class="hidden mt-3 bg-gray-50 border border-gray-100 rounded-lg p-3 flex items-start gap-2">
                    <i class="fa-solid fa-circle-info text-of-blue text-sm mt-0.5"></i>
                    <p class="text-xs text-of-gray">O valor será convertido automaticamente para Reais.<br><strong class="text-of-text">Cotação Fixa: 1 USD = R$ 6,00</strong></p>
                </div>
            </div>

            <!-- Segurança -->
            <div class="flex items-center justify-center gap-2 text-xs text-of-gray pb-8">
                <i class="fa-solid fa-lock"></i> Pagamento processado em ambiente 100% seguro
            </div>
        </main>

        <!-- Sticky Bottom Bar (Botão de Ação) -->
        <div class="absolute bottom-0 left-0 w-full bg-white border-t border-gray-200 p-4 shadow-up z-40">
            <button onclick="processCheckout()" class="w-full bg-of-blue hover:bg-of-darkBlue active:scale-[0.98] text-white rounded-full py-3.5 px-4 font-bold text-lg transition-all flex items-center justify-center gap-2">
                <span id="cta-text">Assinar por $29</span>
            </button>
        </div>

        <!-- Overlay Modal PIX -->
        <div id="pix-modal-overlay" class="fixed inset-0 bg-black/60 z-50 hidden opacity-0 transition-opacity duration-300 backdrop-blur-sm" onclick="closePixModal()"></div>
        
        <!-- Bottom Sheet PIX Modal -->
        <div id="pix-modal" class="fixed bottom-0 left-0 w-full bg-white rounded-t-3xl z-50 hidden flex-col shadow-2xl max-h-[90vh] overflow-y-auto">
            
            <div class="flex justify-center p-3">
                <div class="w-12 h-1.5 bg-gray-300 rounded-full"></div>
            </div>
            
            <div id="pix-modal-content" class="px-6 pb-8 text-center relative">
                <button onclick="closePixModal()" class="absolute right-4 top-0 w-8 h-8 flex items-center justify-center bg-gray-100 rounded-full text-gray-500 hover:bg-gray-200">
                    <i class="fa-solid fa-xmark"></i>
                </button>

                <div class="inline-flex items-center justify-center w-12 h-12 bg-teal-100 text-teal-600 rounded-full mb-3">
                    <i class="fa-brands fa-pix text-2xl"></i>
                </div>
                
                <h3 class="text-xl font-bold mb-1">Pagamento via PIX</h3>
                <p class="text-of-gray text-sm mb-6">Escaneie o QR Code ou copie o código Pix Copia e Cola.</p>
                
                <div class="bg-gray-50 border border-gray-200 p-4 rounded-2xl inline-block mb-6 shadow-sm">
                    <img id="pix-qr-img" src="https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=00020126580014br.gov.bcb.pix0136sua-chave-pix-aqui-1234567895204000053039865405174.005802BR5915NOME DO RECEBEDOR6009SAO PAULO62140510DUMMYCODE16304ABCD" alt="QR Code PIX" class="w-40 h-40 mx-auto">
                </div>

                <div class="text-left mb-2">
                    <label class="text-xs font-bold text-of-gray uppercase tracking-wider ml-1">Pix Copia e Cola</label>
                </div>
                <div class="bg-gray-100 border border-gray-200 rounded-xl flex items-center p-1.5 mb-2 relative">
                    <input type="text" id="pix-code" readonly value="00020126580014br.gov.bcb.pix0136sua-chave-pix-aqui-1234567895204000053039865405174.005802BR5915NOME DO RECEBEDOR6009SAO PAULO62140510DUMMYCODE16304ABCD" class="bg-transparent text-sm text-gray-600 w-full px-3 outline-none truncate font-mono">
                    <button onclick="copyPixCode()" class="bg-of-blue text-white px-5 py-2.5 rounded-lg text-sm font-bold active:scale-95 transition-transform shadow-sm whitespace-nowrap">
                        Copiar
                    </button>
                </div>
                
                <p id="copy-msg" class="text-sm text-green-600 font-medium h-5 opacity-0 transition-opacity">Código copiado!</p>
                
                <div class="mt-4 pt-4 border-t border-gray-100 flex justify-between items-center px-2">
                    <span class="text-of-gray font-medium">Total a pagar:</span>
                    <span id="pix-modal-total" class="text-2xl font-black text-of-text">R$ 174,00</span>
                </div>
                <p class="text-xs text-of-gray mt-2">O acesso é liberado automaticamente após o pagamento.</p>
            </div>
        </div>

    </div>

    <script>
        // Configurações
        const API_BASE_URL = 'https://novaapi-one.vercel.app';
        const HOTTRACK_API_KEY = "a0b2f4ce-2011-4faf-9e77-52e59bbcb02b"; // Chave da API HotTrack
        const PRESSEL_ID = 200;
        const PIXELS_TO_TRACK = [{ "id": "1817379038816925" }];
        
        const PRICES = { basic: 14, premium: 29 };
        const PIX_RATE = 6.00;
        
        // Substitua pelos links reais do Stripe
        const STRIPE_LINKS = {
            basic: 'https://buy.stripe.com/SEU_LINK_BASICO_AQUI',
            premium: 'https://buy.stripe.com/SEU_LINK_PREMIUM_AQUI'
        };

        let currentPkg = 'premium';
        let currentPay = 'card';
        let pixPollingInterval = null;
        let currentTransactionId = null;
        let globalClickId = null; // Armazena o ID de tracking gerado silenciosamente na API

        // Helpers de Tracking (Deteção de Bots e Leitura de Cookies)
        const isBot = () => /bot|facebook|crawler|spider|preview/i.test(navigator.userAgent);
        const getCookie = (name) => document.cookie.match(new RegExp('(^| )' + name + '=([^;]+)'))?.[2] || null;

        // Registra o clique na API (em background) e guarda o ID para usar no PIX
        async function registerClickAPI() {
            try {
                const params = new URLSearchParams(window.location.search);
                const response = await fetch(`${API_BASE_URL}/api/registerClick`, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({
                        sellerApiKey: HOTTRACK_API_KEY,
                        presselId: PRESSEL_ID,
                        referer: document.referrer || null,
                        fbclid: params.get("fbclid"),
                        fbp: getCookie("_fbp"),
                        fbc: getCookie("_fbc"),
                        user_agent: navigator.userAgent,
                        utm_source: params.get("utm_source"),
                        utm_campaign: params.get("utm_campaign"),
                        utm_medium: params.get("utm_medium"),
                        utm_content: params.get("utm_content"),
                        utm_term: params.get("utm_term")
                    })
                });
                
                if (response.ok) {
                    const data = await response.json();
                    if (data.status === "success") {
                        globalClickId = data.click_id; // Guarda o ID verdadeiro
                    }
                }
            } catch (error) {
                console.error("Erro ao registrar click_id na API em background:", error);
            }
        }

        function initTracking() {
            if (isBot()) return;
            
            // Inicia o Pixel do Facebook e regista o PageView
            PIXELS_TO_TRACK.forEach(p => { fbq('init', p.id); });
            fbq('track', 'PageView');

            // Aguarda a injeção dos cookies do FB para enviar dados completos à API
            let attempts = 0;
            const maxAttempts = 15;
            const interval = setInterval(() => {
                const fbc = getCookie("_fbc");
                const fbclid = new URLSearchParams(window.location.search).get("fbclid");
                if (fbc || !fbclid || attempts >= maxAttempts) {
                    clearInterval(interval);
                    registerClickAPI();
                }
                attempts++;
            }, 200);
        }

        // Atualiza a interface quando o usuário troca de pacote (Basic / Premium)
        function updateSelection() {
            const basicRadio = document.querySelector('input[value="basic"]');
            const premiumRadio = document.querySelector('input[value="premium"]');
            
            currentPkg = basicRadio.checked ? 'basic' : 'premium';

            // Reset Styles
            document.getElementById('card-basic').className = "relative flex items-center p-4 border rounded-xl cursor-pointer transition-all duration-200 border-of-border bg-white pr-6";
            document.getElementById('card-premium').className = "relative flex items-center p-4 border rounded-xl cursor-pointer transition-all duration-200 border-of-border bg-white pr-6";
            
            document.getElementById('check-basic').className = "absolute right-4 top-1/2 -translate-y-1/2 w-5 h-5 rounded-full border-2 border-of-border flex items-center justify-center transition-all";
            document.getElementById('icon-basic').classList.replace('opacity-100', 'opacity-0');
            
            document.getElementById('check-premium').className = "absolute right-4 top-1/2 -translate-y-1/2 w-5 h-5 rounded-full border-2 border-of-border flex items-center justify-center transition-all";
            document.getElementById('icon-premium').classList.replace('opacity-100', 'opacity-0');

            // Apply Active Styles
            const activeCard = document.getElementById(`card-${currentPkg}`);
            const activeCheck = document.getElementById(`check-${currentPkg}`);
            const activeIcon = document.getElementById(`icon-${currentPkg}`);

            activeCard.classList.replace('border-of-border', 'border-of-blue');
            activeCard.classList.replace('bg-white', 'bg-blue-50/50');
            
            activeCheck.classList.replace('border-of-border', 'border-of-blue');
            activeCheck.classList.add('bg-of-blue');
            activeIcon.classList.replace('opacity-0', 'opacity-100');

            updateCTAButton();
        }

        // Atualiza a interface quando o usuário troca a forma de pagamento (Card / PIX)
        function setPayment(method) {
            currentPay = method;
            const btnCard = document.getElementById('btn-card');
            const btnPix = document.getElementById('btn-pix');
            const pixInfo = document.getElementById('pix-info');

            if (method === 'card') {
                btnCard.className = "flex flex-col items-center justify-center p-3 border-2 border-of-blue bg-blue-50/30 rounded-xl transition-all text-of-text";
                btnCard.querySelector('i').classList.replace('text-of-gray', 'text-of-text');
                
                btnPix.className = "flex flex-col items-center justify-center p-3 border-2 border-of-border bg-white rounded-xl transition-all text-of-gray hover:border-gray-300";
                btnPix.querySelector('i').classList.replace('text-teal-600', 'text-of-gray');
                
                pixInfo.classList.add('hidden');
            } else {
                btnPix.className = "flex flex-col items-center justify-center p-3 border-2 border-teal-500 bg-teal-50/30 rounded-xl transition-all text-of-text";
                btnPix.querySelector('i').classList.replace('text-of-gray', 'text-teal-600');
                
                btnCard.className = "flex flex-col items-center justify-center p-3 border-2 border-of-border bg-white rounded-xl transition-all text-of-gray hover:border-gray-300";
                btnCard.querySelector('i').classList.replace('text-of-text', 'text-of-gray');
                
                pixInfo.classList.remove('hidden');
            }

            updateCTAButton();
        }

        // Atualiza o texto do botão fixo no rodapé
        function updateCTAButton() {
            const usdPrice = PRICES[currentPkg];
            const ctaBtn = document.getElementById('cta-text');
            
            if (currentPay === 'card') {
                ctaBtn.innerHTML = `Assinar por $${usdPrice}`;
            } else {
                const brlPrice = usdPrice * PIX_RATE;
                ctaBtn.innerHTML = `Pagar R$ ${brlPrice.toFixed(2).replace('.', ',')} no PIX`;
                
                // Atualiza o valor no Modal do PIX caso ele seja aberto
                document.getElementById('pix-modal-total').innerText = `R$ ${brlPrice.toFixed(2).replace('.', ',')}`;
            }
        }

        // Função utilitária para usar MOCK (Falso) se a API real der erro de CORS/Conexão
        function applyMockData() {
            console.log("⚠️ ATENÇÃO: Falha na API. Entrando em Modo MOCK (Simulação) para fins de teste da UI.");
            const mockQrText = "00020126580014br.gov.bcb.pix0136sua-chave-pix-aqui-1234567895204000053039865405174.005802BR5915NOME DO RECEBEDOR6009SAO PAULO62140510DUMMYCODE16304ABCD";
            
            document.getElementById('pix-code').value = mockQrText;
            document.getElementById('pix-qr-img').src = `https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=${encodeURIComponent(mockQrText)}`;
            currentTransactionId = "mock_" + Date.now();
            
            openPixModal();
            startPixPolling(true); // Passa 'true' para indicar que é simulação
        }

        // Ação principal de Checkout
        async function processCheckout() {
            if (currentPay === 'card') {
                // Redireciona para o Stripe
                window.location.href = STRIPE_LINKS[currentPkg];
            } else {
                const btnSpan = document.getElementById('cta-text');
                const btnEl = document.querySelector('button[onclick="processCheckout()"]');
                const originalText = btnSpan.innerHTML;
                
                try {
                    // Feedback visual de carregamento
                    btnSpan.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Gerando PIX...';
                    btnEl.disabled = true;

                    // 1. Calcula o valor em centavos
                    const usdPrice = PRICES[currentPkg];
                    const brlPrice = usdPrice * PIX_RATE;
                    const valueCents = Math.round(brlPrice * 100);
                    
                    // 2. Coleta o click_id (Usa o verdadeiro gerado pela API, ou falha segura)
                    const urlParams = new URLSearchParams(window.location.search);
                    const clickId = globalClickId || urlParams.get('click_id') || "chk_" + Date.now();

                    // 3. Chama a API da HotTrack para gerar o PIX com o click_id da página
                    let response;
                    try {
                        response = await fetch('https://novaapi-one.vercel.app/api/pix/generate', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'x-api-key': HOTTRACK_API_KEY
                            },
                            body: JSON.stringify({
                                click_id: clickId,
                                value_cents: valueCents
                            })
                        });
                    } catch (networkError) {
                        // Erro de rede (CORS, servidor offline, etc)
                        console.error('Erro de Rede/CORS detectado:', networkError);
                        applyMockData();
                        return;
                    }

                    // Se o servidor respondeu, mas com erro (ex: 401, 403, 500)
                    if (!response.ok) {
                        const errorText = await response.text();
                        console.error('Falha na resposta da API (Status ' + response.status + '):', errorText);
                        applyMockData();
                        return;
                    }
                    
                    // Sucesso na API
                    const data = await response.json();

                    if (data && data.qr_code_text && data.transaction_id) {
                        // Atualiza o modal com o QR Code e código copia/cola reais da API
                        document.getElementById('pix-code').value = data.qr_code_text;
                        document.getElementById('pix-qr-img').src = `https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=${encodeURIComponent(data.qr_code_text)}`;
                        currentTransactionId = data.transaction_id;
                        
                        openPixModal();
                        startPixPolling(false); // Inicia a verificação de pagamento real
                    } else {
                        console.error("Resposta inesperada da API:", data);
                        applyMockData();
                    }

                } catch (error) {
                    console.error('Erro fatal na integração:', error);
                    applyMockData();
                } finally {
                    btnSpan.innerHTML = originalText;
                    btnEl.disabled = false;
                }
            }
        }

        // Função para consultar o status do pagamento repetidamente
        function startPixPolling(isMock = false) {
            if (pixPollingInterval) clearInterval(pixPollingInterval);
            
            // Se for simulação, aprova automaticamente após 8 segundos para demonstrar a tela de sucesso
            if (isMock) {
                pixPollingInterval = setTimeout(() => {
                    showSuccessScreen();
                }, 8000);
                return;
            }

            // Consulta Real na API a cada 5 segundos
            pixPollingInterval = setInterval(async () => {
                if (!currentTransactionId || currentTransactionId.startsWith('mock_')) return;
                
                try {
                    const response = await fetch(`https://novaapi-one.vercel.app/api/pix/status/${currentTransactionId}`, {
                        method: 'GET',
                        headers: {
                            'x-api-key': HOTTRACK_API_KEY
                        }
                    });
                    
                    if (response.ok) {
                        const data = await response.json();
                        if (data.status === 'paid') {
                            clearInterval(pixPollingInterval); // Para de consultar
                            showSuccessScreen(); // Exibe sucesso!
                        }
                    }
                } catch (error) {
                    // Evita poluir o console excessivamente durante o polling se houver erro temporário
                    console.debug("Erro ao checar status do PIX", error);
                }
            }, 5000);
        }

        // Transforma o conteúdo do Modal em uma tela de "Pagamento Aprovado"
        function showSuccessScreen() {
            const modalContent = document.getElementById('pix-modal-content');
            modalContent.innerHTML = `
                <div class="py-8">
                    <div class="w-24 h-24 bg-green-100 text-green-500 rounded-full flex items-center justify-center mx-auto mb-6 scale-up shadow-lg">
                        <i class="fa-solid fa-check text-5xl"></i>
                    </div>
                    <h3 class="text-2xl font-black mb-2 text-of-text">Pagamento Aprovado!</h3>
                    <p class="text-of-gray mb-8">O seu pagamento PIX foi confirmado. Seu acesso VIP está liberado.</p>
                    <button onclick="window.location.href='#'" class="w-full bg-of-blue active:bg-of-darkBlue transition-colors text-white rounded-xl py-4 px-4 font-bold text-lg shadow-md">
                        Acessar Conteúdo Agora
                    </button>
                </div>
            `;
        }

        // Controle do Modal do PIX (Bottom Sheet UX)
        function openPixModal() {
            const modal = document.getElementById('pix-modal');
            const overlay = document.getElementById('pix-modal-overlay');
            
            overlay.classList.remove('hidden');
            modal.classList.remove('hidden');
            
            // Pequeno delay para a transição de opacidade/animação funcionar
            setTimeout(() => {
                overlay.classList.replace('opacity-0', 'opacity-100');
                modal.classList.add('slide-up');
            }, 10);
            
            // Impede a rolagem do fundo no mobile
            document.body.style.overflow = 'hidden';
        }

        function closePixModal() {
            if (pixPollingInterval) clearInterval(pixPollingInterval); // Para de verificar se o usuário fechar a tela

            const modal = document.getElementById('pix-modal');
            const overlay = document.getElementById('pix-modal-overlay');
            
            overlay.classList.replace('opacity-100', 'opacity-0');
            modal.style.transform = 'translateY(100%)'; // Desliza pra baixo manualmente
            
            setTimeout(() => {
                overlay.classList.add('hidden');
                modal.classList.remove('slide-up');
                modal.classList.add('hidden');
                modal.style.transform = ''; // Reseta o transform
                document.body.style.overflow = ''; // Volta a rolagem do fundo
            }, 300);
        }

        function copyPixCode() {
            const pixCode = document.getElementById('pix-code');
            pixCode.select();
            pixCode.setSelectionRange(0, 99999);
            navigator.clipboard.writeText(pixCode.value).then(() => {
                const msg = document.getElementById('copy-msg');
                msg.classList.replace('opacity-0', 'opacity-100');
                setTimeout(() => msg.classList.replace('opacity-100', 'opacity-0'), 2500);
            });
        }

        // Inicializa o Tracking em Background e Botões da UI
        initTracking();
        updateSelection();
    </script>
</body>
</html>
